name: Build and Release

on:
  push:
    branches:
      - main
      - master

# Permissions for GitHub Pages deployment and releases
permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Check if commit message starts with [BUILD]
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      commit_message: ${{ steps.check.outputs.commit_message }}
    steps:
      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" == \[BUILD\]* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "commit_message<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  # Build Android APK
  build-android:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Rename APK with date
        run: |
          DATE=$(date +'%Y-%m-%d_%H-%M-%S')
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/project_2359_android_$DATE.apk
          echo "APK_NAME=project_2359_android_$DATE.apk" >> $GITHUB_ENV

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: build/app/outputs/flutter-apk/*.apk

  # Build Windows EXE
  build-windows:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create ZIP archive
        run: |
          $DATE = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
          $ZIP_NAME = "project_2359_windows_$DATE.zip"
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "build\$ZIP_NAME"
          echo "ZIP_NAME=$ZIP_NAME" >> $env:GITHUB_ENV

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: build/*.zip

  # Build Web and Deploy to GitHub Pages
  build-web:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href "/${{ github.event.repository.name }}/"

      - name: Upload web artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web

  # Deploy to GitHub Pages
  deploy-pages:
    needs: build-web
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Create GitHub Release
  create-release:
    needs: [check-trigger, build-android, build-windows]
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: ./artifacts/android

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./artifacts/windows

      - name: Generate release info
        id: release_info
        run: |
          DATE=$(date +'%Y-%m-%d')
          TIME=$(date +'%H:%M:%S UTC')
          DATETIME=$(date +'%Y%m%d%H%M%S')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Extract version from pubspec.yaml
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          
          # Create release tag
          RELEASE_TAG="build-$DATETIME"
          
          # Get commit message (remove [BUILD] prefix)
          COMMIT_MSG="${{ needs.check-trigger.outputs.commit_message }}"
          CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^\[BUILD\]\s*//')
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=Build $DATE - v$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "clean_message=$CLEAN_MSG" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.release_tag }}
          name: ${{ steps.release_info.outputs.release_name }}
          body: |
            ## ğŸš€ Automated Build Release
            
            **ğŸ“… Release Date:** ${{ steps.release_info.outputs.date }}
            **â° Build Time:** ${{ steps.release_info.outputs.time }}
            **ğŸ“¦ Version:** ${{ steps.release_info.outputs.version }}
            **ğŸ”— Commit:** [${{ steps.release_info.outputs.short_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            **ğŸ‘¤ Author:** ${{ github.actor }}
            
            ---
            
            ### ğŸ“ Commit Message
            ${{ steps.release_info.outputs.clean_message }}
            
            ---
            
            ### ğŸ“± Downloads
            
            | Platform | File |
            |----------|------|
            | ğŸ¤– Android | `project_2359_android_*.apk` |
            | ğŸªŸ Windows | `project_2359_windows_*.zip` |
            
            ---
            
            ### ğŸŒ Web App
            
            The web version has been deployed to GitHub Pages:
            **[Launch Web App](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)**
            
            ---
            
            ### â„¹ï¸ Build Information
            
            - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Branch:** `${{ github.ref_name }}`
            - **Flutter Version:** 3.32.1
            
            ---
            
            *This release was automatically generated by GitHub Actions.*
          files: |
            ./artifacts/android/*
            ./artifacts/windows/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
