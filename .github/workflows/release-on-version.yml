name: Release on Version Change

on:
  push:
    branches: [main]
    paths:
      - 'apps/project-2359-rn/package.json'

jobs:
  check-version-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    outputs:
      version_changed: ${{ steps.version_check.outputs.changed }}
      new_version: ${{ steps.version_check.outputs.version }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version_check
        run: |
          # Get current version
          CURRENT_VERSION=$(jq -r '.version' apps/project-2359-rn/package.json)
          
          # Get previous version
          git show HEAD~1:apps/project-2359-rn/package.json > /tmp/old_package.json 2>/dev/null || echo '{"version":"0.0.0"}' > /tmp/old_package.json
          PREVIOUS_VERSION=$(jq -r '.version' /tmp/old_package.json)
          
          echo "Current version: $CURRENT_VERSION"
          echo "Previous version: $PREVIOUS_VERSION"
          
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  build-and-release:
    needs: check-version-and-release
    if: needs.check-version-and-release.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    env:
      APP_NAME: project-2359-rn
      VERSION: ${{ needs.check-version-and-release.outputs.new_version }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/project-2359-rn/package-lock.json

      - name: Install dependencies
        working-directory: apps/project-2359-rn
        run: npm ci

      - name: Setup Expo CLI
        run: npm install -g expo-cli eas-cli

      - name: Setup EAS
        run: eas login --token ${{ secrets.EXPO_TOKEN }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ env.VERSION }}"
          
          if [ -f CHANGELOG.md ]; then
            # Extract content between this version header and the next version header (or EOF)
            # Matches ## X.Y.Z or ## vX.Y.Z patterns
            CHANGELOG=$(awk -v ver="$VERSION" '
              BEGIN { found=0; content="" }
              /^## v?[0-9]+\.[0-9]+\.[0-9]+/ {
                if (found) exit
                if (index($0, ver) > 0) found=1
                next
              }
              found { content = content $0 "\n" }
              END { print content }
            ' CHANGELOG.md)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changelog entry found for version $VERSION"
            fi
          else
            CHANGELOG="No CHANGELOG.md file found"
          fi
          
          # Write to file to preserve multiline content
          echo "$CHANGELOG" > /tmp/changelog_content.txt
          echo "changelog_file=/tmp/changelog_content.txt" >> $GITHUB_OUTPUT

      # ===============================
      # Android APK Build (Production)
      # ===============================
      - name: Build Android APK (Production)
        working-directory: apps/project-2359-rn
        run: eas build --platform android --profile production --non-interactive --local
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Find and rename APK
        id: find_apk
        run: |
          APK_PATH=$(find apps/project-2359-rn -name "*.apk" -type f | head -1)
          if [ -n "$APK_PATH" ]; then
            NEW_APK_PATH="apps/project-2359-rn/${{ env.APP_NAME }}-v${{ env.VERSION }}.apk"
            mv "$APK_PATH" "$NEW_APK_PATH"
            echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          fi

      # ===============================
      # Web Build & Deploy
      # ===============================
      - name: Build Web App
        working-directory: apps/project-2359-rn
        run: npx expo export --platform web --output-dir dist

      - name: Prepare deployment structure
        run: |
          mkdir -p deploy/react-native
          mkdir -p deploy/flutter
          mkdir -p deploy/react
          cp -r apps/project-2359-rn/dist/* deploy/react-native/
          # Create root index
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Project 2359</title></head><body><h1>Project 2359</h1><ul><li><a href="/react-native">React Native App</a></li><li><a href="/flutter">Flutter App</a></li><li><a href="/react">React App</a></li></ul></body></html>' > deploy/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          destination_dir: .
          keep_files: true

      # ===============================
      # Create Official Release
      # ===============================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: "${{ env.APP_NAME }} v${{ env.VERSION }}"
          body_path: ${{ steps.changelog.outputs.changelog_file }}
          files: |
            ${{ steps.find_apk.outputs.apk_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
