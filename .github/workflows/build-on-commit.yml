name: Build on [BUILD] Commit

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - '.github/workflows/build-on-commit.yml'

# Prevent concurrent deployments to avoid conflicts
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Check if commit message starts with [BUILD] and detect changed projects
  # ============================================================================
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      commit_message: ${{ steps.check.outputs.commit_message }}
      project_2359_changed: ${{ steps.changes.outputs.project_2359 }}
      playground_changed: ${{ steps.changes.outputs.playground }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check commit message for [BUILD] trigger
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"
          
          if [[ "$COMMIT_MSG" == \[BUILD\]* ]]; then
            echo "‚úÖ Commit starts with [BUILD] - triggering build"
            echo "should_build=true" >> $GITHUB_OUTPUT
            # Extract the message after [BUILD] for release notes
            CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^\[BUILD\]\s*//')
            echo "commit_message=$CLEAN_MSG" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è Commit does not start with [BUILD] - skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed projects
        id: changes
        run: |
          # Get the list of changed files in this push
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if project_2359 has changes
          if echo "$CHANGED_FILES" | grep -q "^apps/project_2359/"; then
            echo "project_2359=true" >> $GITHUB_OUTPUT
            echo "‚úÖ project_2359 has changes"
          else
            echo "project_2359=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è project_2359 has no changes"
          fi
          
          # Check if playground has changes
          if echo "$CHANGED_FILES" | grep -q "^apps/playground/"; then
            echo "playground=true" >> $GITHUB_OUTPUT
            echo "‚úÖ playground has changes"
          else
            echo "playground=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è playground has no changes"
          fi

  # ============================================================================
  # Build Project 2359 - Web
  # ============================================================================
  build-project-2359-web:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.project_2359_changed == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: apps/project_2359
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href "/"

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-2359-web
          path: apps/project_2359/build/web/
          retention-days: 1

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Build Project 2359 - Android APK
  # ============================================================================
  build-project-2359-android:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.project_2359_changed == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: apps/project_2359
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: project-2359-android
          path: apps/project_2359/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 1

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Build Project 2359 - Windows
  # ============================================================================
  build-project-2359-windows:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.project_2359_changed == 'true'
    runs-on: windows-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: apps/project_2359
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows ZIP
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath project_2359-windows.zip

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: project-2359-windows
          path: apps/project_2359/project_2359-windows.zip
          retention-days: 1

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if ("${{ job.status }}" -eq "success") {
            echo "success=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "success=false" >> $env:GITHUB_OUTPUT
          }

  # ============================================================================
  # Build Project 2359 - Linux
  # ============================================================================
  build-project-2359-linux:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.project_2359_changed == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: apps/project_2359
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build libgtk-3-dev libsqlite3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create Linux Archive
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ../../../../../project_2359-linux.tar.gz *

      - name: Upload Linux Build
        uses: actions/upload-artifact@v4
        with:
          name: project-2359-linux
          path: apps/project_2359/project_2359-linux.tar.gz
          retention-days: 1

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Build Playground - Web Only
  # ============================================================================
  build-playground-web:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true' && needs.check-trigger.outputs.playground_changed == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: apps/playground
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href "/dev/playground/"

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: playground-web
          path: apps/playground/build/web/
          retention-days: 1

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Deploy All Web Builds to GitHub Pages
  # ============================================================================
  deploy-web:
    needs: [check-trigger, build-project-2359-web, build-playground-web]
    if: |
      always() && 
      needs.check-trigger.outputs.should_build == 'true' && 
      (needs.build-project-2359-web.outputs.success == 'true' || needs.build-playground-web.outputs.success == 'true')
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      success: ${{ steps.set_success.outputs.success }}
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Create gh-pages branch if not exists
        run: |
          if ! git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout --orphan gh-pages
            git reset --hard
            git commit --allow-empty -m "Initialize gh-pages"
            git push origin gh-pages
          fi
        continue-on-error: true

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-content

      - name: Download Project 2359 Web Build
        if: needs.build-project-2359-web.outputs.success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: project-2359-web
          path: project-2359-web

      - name: Download Playground Web Build
        if: needs.build-playground-web.outputs.success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: playground-web
          path: playground-web

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          
          # Copy existing gh-pages content to preserve other files
          if [ -d "gh-pages-content" ]; then
            cp -r gh-pages-content/* deploy/ 2>/dev/null || true
            rm -rf deploy/.git
          fi
          
          # Deploy Project 2359 to root (if built)
          if [ -d "project-2359-web" ]; then
            echo "üì¶ Deploying Project 2359 to root..."
            # Remove old root files but keep dev folder
            find deploy -maxdepth 1 -type f -delete 2>/dev/null || true
            for dir in deploy/*/; do
              [ "$(basename "$dir")" != "dev" ] && rm -rf "$dir" 2>/dev/null || true
            done
            cp -r project-2359-web/* deploy/
          fi
          
          # Deploy Playground to /dev/playground (if built)
          if [ -d "playground-web" ]; then
            echo "üì¶ Deploying Playground to /dev/playground..."
            mkdir -p deploy/dev/playground
            rm -rf deploy/dev/playground/*
            cp -r playground-web/* deploy/dev/playground/
          fi
          
          # Create .nojekyll to bypass Jekyll processing
          touch deploy/.nojekyll
          
          echo "üìÅ Deployment structure:"
          ls -la deploy/
          [ -d "deploy/dev" ] && ls -la deploy/dev/ || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          destination_dir: .
          keep_files: false

      - name: Set success status
        id: set_success
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Create Release for Project 2359
  # ============================================================================
  create-release-project-2359:
    needs: [check-trigger, build-project-2359-android, build-project-2359-windows, build-project-2359-linux, deploy-web]
    if: |
      always() && 
      needs.check-trigger.outputs.should_build == 'true' && 
      needs.check-trigger.outputs.project_2359_changed == 'true' &&
      (needs.build-project-2359-android.outputs.success == 'true' || 
       needs.build-project-2359-windows.outputs.success == 'true' || 
       needs.build-project-2359-linux.outputs.success == 'true')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android APK
        if: needs.build-project-2359-android.outputs.success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: project-2359-android
          path: ./release-assets

      - name: Download Windows Build
        if: needs.build-project-2359-windows.outputs.success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: project-2359-windows
          path: ./release-assets

      - name: Download Linux Build
        if: needs.build-project-2359-linux.outputs.success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: project-2359-linux
          path: ./release-assets

      - name: Rename APK
        if: needs.build-project-2359-android.outputs.success == 'true'
        run: mv ./release-assets/app-release.apk ./release-assets/project_2359-android.apk

      - name: Get build information
        id: build_info
        run: |
          BUILD_DATE=$(date -u +'%Y-%m-%d')
          BUILD_TIME=$(date -u +'%H:%M:%S UTC')
          BUILD_DATETIME=$(date -u +'%Y%m%d-%H%M%S')
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BUILD_NUMBER="${{ github.run_number }}"
          
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "build_datetime=$BUILD_DATETIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Determine build status
        id: build_status
        run: |
          ANDROID_SUCCESS="${{ needs.build-project-2359-android.outputs.success }}"
          WINDOWS_SUCCESS="${{ needs.build-project-2359-windows.outputs.success }}"
          LINUX_SUCCESS="${{ needs.build-project-2359-linux.outputs.success }}"
          WEB_SUCCESS="${{ needs.deploy-web.outputs.success }}"
          
          echo "android_success=${ANDROID_SUCCESS}" >> $GITHUB_OUTPUT
          echo "windows_success=${WINDOWS_SUCCESS}" >> $GITHUB_OUTPUT
          echo "linux_success=${LINUX_SUCCESS}" >> $GITHUB_OUTPUT
          echo "web_success=${WEB_SUCCESS}" >> $GITHUB_OUTPUT
          
          SUCCESS_COUNT=0
          [ "$ANDROID_SUCCESS" == "true" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "$WINDOWS_SUCCESS" == "true" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "$LINUX_SUCCESS" == "true" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "$WEB_SUCCESS" == "true" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          
          if [ $SUCCESS_COUNT -eq 4 ]; then
            echo "release_type=Complete" >> $GITHUB_OUTPUT
          elif [ $SUCCESS_COUNT -eq 0 ]; then
            echo "release_type=Failed" >> $GITHUB_OUTPUT
          else
            echo "release_type=Partial" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          
          cat > release_notes.md << EOF
          # üöÄ Project 2359 - Build #${{ steps.build_info.outputs.build_number }}
          
          ## üìã Build Information
          
          | Property | Value |
          |----------|-------|
          | üìÖ **Build Date** | ${{ steps.build_info.outputs.build_date }} |
          | üïê **Build Time** | ${{ steps.build_info.outputs.build_time }} |
          | üìù **Commit** | \`${{ steps.build_info.outputs.short_sha }}\` |
          | üë§ **Triggered By** | @${{ github.actor }} |
          
          ## üí¨ Commit Message
          
          > ${{ needs.check-trigger.outputs.commit_message }}
          
          ## üì¶ Available Downloads
          
          | Platform | Status | Description |
          |----------|--------|-------------|
          | ü§ñ Android | ${{ steps.build_status.outputs.android_success == 'true' && '‚úÖ' || '‚ùå' }} | Release APK |
          | ü™ü Windows | ${{ steps.build_status.outputs.windows_success == 'true' && '‚úÖ' || '‚ùå' }} | Portable executable |
          | üêß Linux | ${{ steps.build_status.outputs.linux_success == 'true' && '‚úÖ' || '‚ùå' }} | Linux bundle |
          | üåê Web | ${{ steps.build_status.outputs.web_success == 'true' && '‚úÖ' || '‚ùå' }} | [Open Web App](${PAGES_URL}) |
          
          ---
          *Automated build triggered by \`[BUILD]\` commit prefix.*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: project-2359-${{ steps.build_info.outputs.build_datetime }}-${{ steps.build_info.outputs.short_sha }}
          name: "Project 2359 - Build #${{ steps.build_info.outputs.build_number }} (${{ steps.build_info.outputs.build_date }})"
          body_path: release_notes.md
          files: |
            ./release-assets/project_2359-android.apk
            ./release-assets/project_2359-windows.zip
            ./release-assets/project_2359-linux.tar.gz
          draft: false
          prerelease: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Create Release for Playground (Web only - no binaries)
  # ============================================================================
  create-release-playground:
    needs: [check-trigger, build-playground-web, deploy-web]
    if: |
      always() && 
      needs.check-trigger.outputs.should_build == 'true' && 
      needs.check-trigger.outputs.playground_changed == 'true' &&
      needs.build-playground-web.outputs.success == 'true'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get build information
        id: build_info
        run: |
          BUILD_DATE=$(date -u +'%Y-%m-%d')
          BUILD_DATETIME=$(date -u +'%Y%m%d-%H%M%S')
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BUILD_NUMBER="${{ github.run_number }}"
          
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_datetime=$BUILD_DATETIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Generate release notes
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          PLAYGROUND_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/dev/playground"
          
          cat > release_notes.md << EOF
          # üß™ Playground - Build #${{ steps.build_info.outputs.build_number }}
          
          ## üìã Build Information
          
          | Property | Value |
          |----------|-------|
          | üìÖ **Build Date** | ${{ steps.build_info.outputs.build_date }} |
          | üìù **Commit** | \`${{ steps.build_info.outputs.short_sha }}\` |
          | üë§ **Triggered By** | @${{ github.actor }} |
          
          ## üí¨ Commit Message
          
          > ${{ needs.check-trigger.outputs.commit_message }}
          
          ## üåê Web Deployment
          
          The playground is deployed to: [${PLAYGROUND_URL}](${PLAYGROUND_URL})
          
          ---
          *Automated build triggered by \`[BUILD]\` commit prefix.*
          *This is a development/experimental project.*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: playground-${{ steps.build_info.outputs.build_datetime }}-${{ steps.build_info.outputs.short_sha }}
          name: "Playground - Build #${{ steps.build_info.outputs.build_number }} (${{ steps.build_info.outputs.build_date }})"
          body_path: release_notes.md
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}